<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Knowledge Base</title>
    <link rel="stylesheet" href="static/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>AI Knowledge Base</h2>
                <button class="new-chat-btn" id="new-chat-btn">
                    <i class="fas fa-plus"></i> New Chat
                </button>
                <button class="new-chat-btn" id="settings-btn">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button class="new-chat-btn logout-btn" id="logout-btn" onclick="logout()" style="display:none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <div id="projects-section" class="projects-section">
                    <button class="new-chat-btn" id="toggle-projects-btn">
                        ▼ Projects
                    </button>
                    <button class="new-chat-btn" id="new-project-btn">
                        + New Project
                    </button>
                    <div id="new-project-input-row" style="display:none;">
                        <input type="text" class="project-input" id="new-project-input" placeholder="Project name..." onkeydown="window.app.handleNewProjectInput(event)">
                    </div>
                    <div id="project-list"></div>
                </div>
            </div>
            
            <div class="search-section">
                <div class="search-input-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="conversation-search" placeholder="Search conversations..." oninput="debouncedSearchConversations()">
                </div>
            </div>

            <div class="conversations-list" id="conversations-list">
                <!-- Conversations will be loaded here -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-content">
            <div class="chat-header">
                <div class="model-selector">
                    <select id="llm-model" onchange="updateModel()">
                        <optgroup label="OpenAI">
                            <option value="gpt-3.5-turbo" selected>GPT-3.5 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-4o">GPT-4o</option>
                            <option value="gpt-4o-mini">GPT-4o Mini</option>
                            <option value="o1-preview">O1 Preview</option>
                            <option value="o1-mini">O1 Mini</option>
                        </optgroup>
                        <optgroup label="Anthropic">
                            <option value="claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                            <option value="claude-3-opus">Claude 3 Opus</option>
                            <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                            <option value="claude-3-haiku">Claude 3 Haiku</option>
                        </optgroup>
                        <optgroup label="Google">
                            <option value="gemini-pro">Gemini Pro</option>
                            <option value="gemini-flash">Gemini Flash</option>
                        </optgroup>
                        <optgroup label="Hugging Face">
                            <option value="llama2-70b">Llama 2 70B</option>
                            <option value="mixtral-8x7b">Mixtral 8x7B</option>
                            <option value="codellama-34b">CodeLlama 34B</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="conversation-actions">
                    <button class="action-btn" onclick="toggleContextPanel()" title="Context Panel" id="context-toggle-btn">
                        <i class="fas fa-layer-group"></i>
                    </button>
                    <button class="action-btn" onclick="exportConversation()" title="Export to Markdown">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="action-btn" onclick="tagConversation()" title="Organize with Tags">
                        <i class="fas fa-tags"></i>
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="welcome-message">
                    <h3>Welcome to your AI Knowledge Base</h3>
                    <p>Start a conversation or search your previous chats to find relevant information.</p>
                </div>
            </div>

            <!-- Context Panel -->
            <div class="context-panel" id="context-panel" style="display: none;">
                <div class="context-header">
                    <h4><i class="fas fa-layer-group"></i> Active Context</h4>
                    <div class="context-actions">
                        <button class="context-btn" onclick="addNewContext()" title="Add Context">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="context-btn" onclick="refreshContextPanel()" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="context-btn" onclick="toggleContextPanel()" title="Close Panel">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="context-content">
                    <div class="context-stats" id="context-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Items:</span>
                            <span class="stat-value" id="total-context-items">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Tokens:</span>
                            <span class="stat-value" id="total-context-tokens">0</span>
                        </div>
                    </div>
                    <div class="context-conversation-section" id="context-conversation-section" style="display: none;">
                        <h5>Context for This Conversation</h5>
                        <div class="conversation-context-list" id="conversation-context-list">
                            <div class="empty-context">No context items added to this conversation yet.</div>
                        </div>
                    </div>
                    <div class="context-items-section">
                        <h5>Available Context Items</h5>
                        <div class="context-search-container">
                            <input type="text" id="context-search" placeholder="Search context items..." onkeyup="searchContextItems()">
                        </div>
                        <div class="context-items-list" id="context-items-list">
                            <div class="loading-context">Loading context items...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="kb-search-results" id="kb-search-results" style="display: none;">
                    <!-- Knowledge base search results will appear here -->
                </div>
                
                <div class="input-section">
                    <div class="input-controls">
                        <button class="input-btn" onclick="triggerFileUpload()" title="Upload File">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="input-btn" onclick="startVoiceInput()" title="Voice Input" id="voice-btn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="input-btn" onclick="addUrlReference()" title="Add URL">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                    
                    <div class="message-input-wrapper">
                        <textarea id="message-input" placeholder="Search knowledge base or ask a question..." 
                                rows="1" onkeydown="handleInputKeydown(event)" oninput="handleInputChange()"></textarea>
                        <button class="send-btn" onclick="sendMessage()" id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <input type="file" id="file-input" multiple style="display: none;" onchange="window.app.handleContextUpload(event)">
            </div>
        </div>
    </div>

    <!-- Modals -->

    <div id="tag-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-tags"></i> Organize Conversation</h3>
                <span class="close" onclick="closeTagModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="tag-explanation">
                    <p><strong>What are tags?</strong> Tags help you organize and find conversations by topic.</p>
                    <p><strong>Examples:</strong> <code>python</code>, <code>work-project</code>, <code>tutorial</code>, <code>research</code></p>
                    <p><strong>Benefits:</strong> Search conversations by tag, group related discussions, quick filtering</p>
                </div>
                
                <div class="tag-input-section">
                    <label for="tag-input"><strong>Add tags to this conversation:</strong></label>
                    <input type="text" id="tag-input" placeholder="Type tags separated by commas (e.g., python, tutorial, debugging)" onkeydown="handleTagInput(event)">
                    <div class="tag-input-help">
                        <small><i class="fas fa-lightbulb"></i> Tip: Use short, descriptive words. Tags are searchable in the conversation list.</small>
                    </div>
                </div>
                
                <div class="current-conversation-tags">
                    <label><strong>Current tags for this conversation:</strong></label>
                    <div class="conversation-current-tags" id="conversation-current-tags">
                        <span class="no-tags">No tags yet</span>
                    </div>
                </div>
                
                <div class="suggested-tags-section">
                    <label><strong>Quick add (click to add):</strong></label>
                    <div class="existing-tags" id="existing-tags">
                        <!-- Existing tags from other conversations will appear here -->
                    </div>
                </div>
                
                <div class="tag-modal-actions">
                    <button class="btn-primary" onclick="saveTags()"><i class="fas fa-save"></i> Save Tags</button>
                    <button class="btn-secondary" onclick="closeTagModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings & Usage Tracking</h3>
                <span class="close" onclick="window.app.closeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body" id="settings-body">
                <div class="settings-tabs">
                    <button class="tab-btn active" onclick="showTab('usage')">Usage Stats</button>
                    <button class="tab-btn" onclick="showTab('whitelist')" id="whitelist-tab" style="display:none;">IP Whitelist</button>
                </div>
                
                <div id="usage-tab" class="tab-content">
                    <canvas id="llm-usage-chart" style="max-width:100%;margin-bottom:20px;"></canvas>
                    <!-- Usage, error, and LLM cost stats will appear here -->
                    <div id="llm-usage-table"></div>
                </div>
                
                <div id="whitelist-tab-content" class="tab-content" style="display:none;">
                    <div class="admin-section">
                        <h4>Current IP Address</h4>
                        <div id="current-ip-info" style="padding: 10px; background: #f8f9fa; border-radius: 4px; margin-bottom: 20px;">
                            <div id="current-ip-display">Loading...</div>
                            <button class="btn btn-sm btn-primary" onclick="whitelistCurrentIP()" id="whitelist-current-btn">
                                Add to Whitelist
                            </button>
                        </div>
                        
                        <h4>Add IP to Whitelist</h4>
                        <div style="margin-bottom: 20px;">
                            <input type="text" id="new-ip-address" placeholder="192.168.1.1" style="margin-right: 10px; padding: 5px;">
                            <input type="text" id="ip-description" placeholder="Description (optional)" style="margin-right: 10px; padding: 5px;">
                            <button class="btn btn-primary" onclick="addIPToWhitelist()">Add IP</button>
                        </div>
                        
                        <h4>Whitelisted IPs</h4>
                        <div id="whitelist-table">
                            <div class="loading">Loading whitelist...</div>
                        </div>
                        
                        <h4>Usage Statistics</h4>
                        <div id="usage-stats">
                            <div class="loading">Loading stats...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="static/js/app.js"></script>
    <script>
        // Authentication functions
        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/status');
                const data = await response.json();
                
                if (data.auth_enabled) {
                    document.getElementById('logout-btn').style.display = 'block';
                }
                
                // Show free tier usage if applicable
                if (data.free_access && !data.authenticated) {
                    showUsageIndicator(data.free_access);
                }
                
                return data;
            } catch (error) {
                console.error('Failed to check auth status:', error);
                return { authenticated: false, auth_enabled: false };
            }
        }

        function showUsageIndicator(freeAccess) {
            const existingIndicator = document.getElementById('usage-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            const indicator = document.createElement('div');
            indicator.id = 'usage-indicator';
            indicator.className = 'usage-indicator';
            
            const remaining = freeAccess.queries_remaining;
            const total = freeAccess.limit;
            const used = freeAccess.queries_used;
            
            if (remaining <= 0) {
                indicator.className += ' danger';
                const hours = Math.floor(freeAccess.hours_until_reset || 0);
                const minutes = Math.floor(((freeAccess.hours_until_reset || 0) % 1) * 60);
                const resetText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                
                indicator.innerHTML = `
                    <div><strong>Free queries exhausted</strong></div>
                    <div>Used: ${used}/${total}</div>
                    <div><small>Resets in ${resetText}</small></div>
                    <div><small>Login for unlimited access</small></div>
                `;
            } else if (remaining <= 3) {
                indicator.className += ' warning';
                indicator.innerHTML = `
                    <div><strong>${remaining} free queries left</strong></div>
                    <div>Used: ${used}/${total}</div>
                `;
            } else {
                indicator.innerHTML = `
                    <div><strong>${remaining} free queries remaining</strong></div>
                    <div>Used: ${used}/${total}</div>
                `;
            }
            
            document.body.appendChild(indicator);
        }

        async function logout() {
            try {
                const response = await fetch('/auth/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Admin functions
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.classList.add('active');
            
            if (tabName === 'whitelist') {
                loadWhitelistData();
            }
        }
        
        async function loadWhitelistData() {
            try {
                // Load current IP
                const ipResponse = await fetch('/admin/current-ip');
                const ipData = await ipResponse.json();
                
                const currentIPDisplay = document.getElementById('current-ip-display');
                const whitelistBtn = document.getElementById('whitelist-current-btn');
                
                if (ipData.is_whitelisted) {
                    currentIPDisplay.innerHTML = `
                        <strong>${ipData.ip_address}</strong> - <span style="color: green;">✓ Whitelisted</span><br>
                        <small>${ipData.whitelist_info.description || 'No description'}</small>
                    `;
                    whitelistBtn.style.display = 'none';
                } else {
                    currentIPDisplay.innerHTML = `<strong>${ipData.ip_address}</strong> - <span style="color: orange;">Not whitelisted</span>`;
                    whitelistBtn.style.display = 'inline-block';
                }
                
                // Load whitelist
                const whitelistResponse = await fetch('/admin/whitelist');
                const whitelist = await whitelistResponse.json();
                
                const whitelistTable = document.getElementById('whitelist-table');
                if (whitelist.length === 0) {
                    whitelistTable.innerHTML = '<div>No IPs whitelisted</div>';
                } else {
                    whitelistTable.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <th style="text-align: left; padding: 8px;">IP Address</th>
                                    <th style="text-align: left; padding: 8px;">Description</th>
                                    <th style="text-align: left; padding: 8px;">Added</th>
                                    <th style="text-align: center; padding: 8px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${whitelist.map(entry => `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px; font-family: monospace;">${entry.ip_address}</td>
                                        <td style="padding: 8px;">${entry.description || 'No description'}</td>
                                        <td style="padding: 8px;">${new Date(entry.created_at).toLocaleDateString()}</td>
                                        <td style="padding: 8px; text-align: center;">
                                            <button class="btn btn-sm btn-danger" onclick="removeIPFromWhitelist('${entry.ip_address}')">Remove</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                
                // Load usage stats
                const statsResponse = await fetch('/admin/usage-stats');
                const stats = await statsResponse.json();
                
                document.getElementById('usage-stats').innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>Today:</strong> ${stats.today_stats.total_queries} queries from ${stats.today_stats.unique_ips} unique IPs<br>
                        <strong>Whitelisted IPs:</strong> ${stats.whitelist_count}
                    </div>
                    <div>
                        <strong>Top IPs (Last 7 Days):</strong>
                        <ul style="margin-top: 10px;">
                            ${stats.top_ips.slice(0, 5).map(ip => `
                                <li style="margin: 5px 0; font-family: monospace;">
                                    ${ip.ip_address}: ${ip.total_queries} queries, ${ip.unique_sessions} sessions
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
                
            } catch (error) {
                console.error('Failed to load whitelist data:', error);
                document.getElementById('whitelist-table').innerHTML = '<div style="color: red;">Failed to load data</div>';
            }
        }
        
        async function whitelistCurrentIP() {
            try {
                const ipResponse = await fetch('/admin/current-ip');
                const ipData = await ipResponse.json();
                
                const description = prompt('Enter description for this IP:', 'Demo Access');
                if (description === null) return;
                
                const response = await fetch('/admin/whitelist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip_address: ipData.ip_address,
                        description: description,
                        created_by: 'admin'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('IP added to whitelist successfully!');
                    loadWhitelistData();
                } else {
                    alert('Error: ' + result.error);
                }
                
            } catch (error) {
                alert('Failed to add IP to whitelist');
            }
        }
        
        async function addIPToWhitelist() {
            const ip = document.getElementById('new-ip-address').value.trim();
            const description = document.getElementById('ip-description').value.trim() || 'Demo Access';
            
            if (!ip) {
                alert('Please enter an IP address');
                return;
            }
            
            try {
                const response = await fetch('/admin/whitelist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip_address: ip,
                        description: description,
                        created_by: 'admin'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('IP added to whitelist successfully!');
                    document.getElementById('new-ip-address').value = '';
                    document.getElementById('ip-description').value = '';
                    loadWhitelistData();
                } else {
                    alert('Error: ' + result.error);
                }
                
            } catch (error) {
                alert('Failed to add IP to whitelist');
            }
        }
        
        async function removeIPFromWhitelist(ip) {
            if (!confirm(`Remove ${ip} from whitelist?`)) return;
            
            try {
                const response = await fetch(`/admin/whitelist/${encodeURIComponent(ip)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('IP removed from whitelist');
                    loadWhitelistData();
                } else {
                    alert('Error: ' + result.error);
                }
                
            } catch (error) {
                alert('Failed to remove IP from whitelist');
            }
        }

        // Check auth status on load and show admin tab if authenticated
        document.addEventListener('DOMContentLoaded', async () => {
            const authStatus = await checkAuthStatus();
            if (authStatus.authenticated) {
                document.getElementById('whitelist-tab').style.display = 'inline-block';
            }
        });
    </script>
</body>
</html>