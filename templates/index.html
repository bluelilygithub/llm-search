<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Knowledge Base</title>
    <link rel="stylesheet" href="static/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>AI Knowledge Base</h2>
                <button class="new-chat-btn" id="new-chat-btn">
                    <i class="fas fa-plus"></i> New Chat
                </button>
                <button class="new-chat-btn" id="settings-btn">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button class="new-chat-btn logout-btn" id="logout-btn" onclick="logout()" style="display:none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <div id="projects-section" class="projects-section">
                    <button class="new-chat-btn" id="toggle-projects-btn">
                        â–¼ Projects
                    </button>
                    <button class="new-chat-btn" id="new-project-btn">
                        + New Project
                    </button>
                    <div id="new-project-input-row" style="display:none;">
                        <input type="text" class="project-input" id="new-project-input" placeholder="Project name..." onkeydown="window.app.handleNewProjectInput(event)">
                    </div>
                    <div id="project-list"></div>
                </div>
            </div>
            
            <div class="search-section">
                <div class="search-input-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="conversation-search" placeholder="Search conversations..." onkeyup="searchConversations()">
                </div>
            </div>

            <div class="conversations-list" id="conversations-list">
                <!-- Conversations will be loaded here -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-content">
            <div class="chat-header">
                <div class="model-selector">
                    <select id="llm-model" onchange="updateModel()">
                        <optgroup label="OpenAI">
                            <option value="gpt-3.5-turbo" selected>GPT-3.5 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-4o">GPT-4o</option>
                            <option value="gpt-4o-mini">GPT-4o Mini</option>
                            <option value="o1-preview">O1 Preview</option>
                            <option value="o1-mini">O1 Mini</option>
                        </optgroup>
                        <optgroup label="Anthropic">
                            <option value="claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                            <option value="claude-3-opus">Claude 3 Opus</option>
                            <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                            <option value="claude-3-haiku">Claude 3 Haiku</option>
                        </optgroup>
                        <optgroup label="Google">
                            <option value="gemini-pro">Gemini Pro</option>
                            <option value="gemini-flash">Gemini Flash</option>
                        </optgroup>
                        <optgroup label="Hugging Face">
                            <option value="llama2-70b">Llama 2 70B</option>
                            <option value="mixtral-8x7b">Mixtral 8x7B</option>
                            <option value="codellama-34b">CodeLlama 34B</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="conversation-actions">
                    <button class="action-btn" onclick="searchKnowledgeBase()" title="Search Knowledge Base">
                        <i class="fas fa-database"></i>
                    </button>
                    <button class="action-btn" onclick="exportConversation()" title="Export to Markdown">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="action-btn" onclick="tagConversation()" title="Add Tags">
                        <i class="fas fa-tags"></i>
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="welcome-message">
                    <h3>Welcome to your AI Knowledge Base</h3>
                    <p>Start a conversation or search your previous chats to find relevant information.</p>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="kb-search-results" id="kb-search-results" style="display: none;">
                    <!-- Knowledge base search results will appear here -->
                </div>
                
                <div class="input-section">
                    <div class="input-controls">
                        <button class="input-btn" onclick="triggerFileUpload()" title="Upload File">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="input-btn" onclick="startVoiceInput()" title="Voice Input" id="voice-btn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="input-btn" onclick="addUrlReference()" title="Add URL">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                    
                    <div class="message-input-wrapper">
                        <textarea id="message-input" placeholder="Search knowledge base or ask a question..." 
                                rows="1" onkeydown="handleInputKeydown(event)" oninput="handleInputChange()"></textarea>
                        <button class="send-btn" onclick="sendMessage()" id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <input type="file" id="file-input" multiple style="display: none;" onchange="window.app.handleContextUpload(event)">
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="search-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Search Knowledge Base</h3>
                <span class="close" onclick="closeSearchModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" id="kb-search-input" placeholder="Search your conversations..." onkeyup="performKnowledgeBaseSearch()">
                <div id="search-results-container">
                    <!-- Search results will appear here -->
                </div>
            </div>
        </div>
    </div>

    <div id="tag-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Tags</h3>
                <span class="close" onclick="closeTagModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" id="tag-input" placeholder="Add tags (comma separated)..." onkeydown="handleTagInput(event)">
                <div class="existing-tags" id="existing-tags">
                    <!-- Existing tags will appear here -->
                </div>
                <button onclick="saveTags()">Save Tags</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings & Usage Tracking</h3>
                <span class="close" onclick="window.app.closeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body" id="settings-body">
                <canvas id="llm-usage-chart" style="max-width:100%;margin-bottom:20px;"></canvas>
                <!-- Usage, error, and LLM cost stats will appear here -->
                <div id="llm-usage-table"></div>
            </div>
        </div>
    </div>

    <script src="static/js/app.js"></script>
    <script>
        // Authentication functions
        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/status');
                const data = await response.json();
                
                if (data.auth_enabled) {
                    document.getElementById('logout-btn').style.display = 'block';
                }
                
                // Show free tier usage if applicable
                if (data.free_access && !data.authenticated) {
                    showUsageIndicator(data.free_access);
                }
                
                return data;
            } catch (error) {
                console.error('Failed to check auth status:', error);
                return { authenticated: false, auth_enabled: false };
            }
        }

        function showUsageIndicator(freeAccess) {
            const existingIndicator = document.getElementById('usage-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            const indicator = document.createElement('div');
            indicator.id = 'usage-indicator';
            indicator.className = 'usage-indicator';
            
            const remaining = freeAccess.queries_remaining;
            const total = freeAccess.limit;
            const used = freeAccess.queries_used;
            
            if (remaining <= 0) {
                indicator.className += ' danger';
                indicator.innerHTML = `
                    <div><strong>Free queries exhausted</strong></div>
                    <div>Used: ${used}/${total}</div>
                    <div><small>Login for unlimited access</small></div>
                `;
            } else if (remaining <= 3) {
                indicator.className += ' warning';
                indicator.innerHTML = `
                    <div><strong>${remaining} free queries left</strong></div>
                    <div>Used: ${used}/${total}</div>
                `;
            } else {
                indicator.innerHTML = `
                    <div><strong>${remaining} free queries remaining</strong></div>
                    <div>Used: ${used}/${total}</div>
                `;
            }
            
            document.body.appendChild(indicator);
        }

        async function logout() {
            try {
                const response = await fetch('/auth/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Check auth status on load
        document.addEventListener('DOMContentLoaded', checkAuthStatus);
    </script>
</body>
</html>