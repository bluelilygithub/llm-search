<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>AI Knowledge Base</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Improved Sidebar -->
        <div class="sidebar" id="sidebar">
            <!-- Header -->
            <div class="sidebar-header">
                <div class="sidebar-header-content">
                    <div class="sidebar-logo">
                        <div class="logo-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="logo-text" id="logo-text">
                            <h1>AI Knowledge Base</h1>
                        </div>
                    </div>
                    <button class="inline-flex items-center justify-center relative shrink-0 can-focus select-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none disabled:drop-shadow-none text-text-300 border-transparent transition font-ui tracking-tight duration-300 ease-[cubic-bezier(0.165,0.85,0.45,1)] hover:bg-bg-300 aria-checked:bg-bg-400 aria-expanded:bg-bg-400 hover:text-text-100 aria-pressed:text-text-100 aria-checked:text-text-100 aria-expanded:text-text-100 h-8 w-8 rounded-md active:scale-95 text-text-400/60 hover:text-text-200 sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()" type="button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256" id="toggle-icon">
                            <path d="M232,128a8,8,0,0,1-8,8H91.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L91.31,120H224A8,8,0,0,1,232,128ZM40,32a8,8,0,0,0-8,8V216a8,8,0,0,0,16,0V40A8,8,0,0,0,40,32Z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Search & New Chat (Visible when expanded) -->
            <div class="sidebar-main-actions" id="sidebar-main-actions">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="conversation-search" placeholder="Search conversations, projects..." oninput="debouncedSearchConversations()">
                    </div>
                </div>

                <div class="new-chat-container">
                    <button class="new-chat-btn" id="new-chat-btn" onclick="startNewChat()">
                        <i class="fas fa-plus"></i>
                        <span>New Chat</span>
                    </button>
                </div>
            </div>

            <!-- Navigation Content -->
            <div class="sidebar-content" id="sidebar-content">
                <!-- Recent Conversations Section -->
                <div class="nav-section">
                    <button class="section-header" onclick="toggleSection('recent')" id="recent-header">
                        <div class="section-header-content">
                            <div class="section-title">
                                <i class="fas fa-clock"></i>
                                <span class="section-label">Recent</span>
                            </div>
                            <div class="section-toggle">
                                <i class="fas fa-minus" id="recent-toggle"></i>
                            </div>
                        </div>
                    </button>
                    
                    <div class="section-content expanded" id="recent-content">
                        <div class="conversations-scroll-area">
                            <div class="conversations-list" id="conversations-list">
                                <!-- Recent conversations will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Projects Section -->
                <div class="nav-section" id="projects-section" style="display: none;">
                    <button class="section-header" onclick="toggleSection('projects')" id="projects-header">
                        <div class="section-header-content">
                            <div class="section-title">
                                <i class="fas fa-folder-open"></i>
                                <span class="section-label">Projects</span>
                            </div>
                            <div class="section-toggle">
                                <i class="fas fa-minus" id="projects-toggle"></i>
                            </div>
                        </div>
                    </button>
                    
                    <div class="section-content expanded" id="projects-content">
                        <div class="projects-scroll-area">
                            <div class="project-list" id="project-list">
                                <!-- Projects will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- New Project Button -->
                        <div class="new-project-container">
                            <button class="new-project-btn" id="new-project-btn" onclick="showNewProjectInput()">
                                <div class="new-project-icon">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <span>New Project</span>
                            </button>
                            
                            <!-- Hidden input for new project -->
                            <div class="new-project-input-container" id="new-project-input-row" style="display:none;">
                                <input type="text" class="new-project-input" id="new-project-input" placeholder="Project name..." onkeydown="handleNewProjectInput(event)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collapsed Sidebar Icons -->
            <div class="sidebar-collapsed-content" id="sidebar-collapsed-content" style="display: none;">
                <div class="collapsed-nav-icons">
                    <button class="collapsed-nav-btn" onclick="toggleSection('recent')" title="Recent">
                        <i class="fas fa-clock"></i>
                    </button>
                    <button class="collapsed-nav-btn" onclick="toggleSection('projects')" title="Projects">
                        <i class="fas fa-folder-open"></i>
                    </button>
                </div>
            </div>

            <!-- Bottom Settings -->
            <div class="sidebar-footer" id="sidebar-footer">
                <button class="settings-btn" id="sidebar-settings-btn" onclick="openSettingsPanel()" title="Settings" style="display: none;">
                    <i class="fas fa-cog"></i>
                    <span class="settings-label">Settings</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <div class="model-selector-container">
                        <select class="model-selector" id="llm-model" onchange="updateModel()">
                            <optgroup label="OpenAI">
                                <option value="gpt-3.5-turbo" selected>GPT-3.5 Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4o-mini">GPT-4o Mini</option>
                                <option value="gpt-5">ChatGPT 5</option>
                                <option value="o1-preview">O1 Preview</option>
                                <option value="o1-mini">O1 Mini</option>
                            </optgroup>
                            <optgroup label="Anthropic">
                                <option value="claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                                <option value="claude-3-opus">Claude 3 Opus</option>
                                <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                <option value="claude-3-haiku">Claude 3 Haiku</option>
                            </optgroup>
                            <optgroup label="Google">
                                <option value="gemini-pro">Gemini Pro</option>
                                <option value="gemini-flash">Gemini Flash</option>
                            </optgroup>
                            <optgroup label="Hugging Face">
                                <option value="llama2-70b">Llama 2 70B</option>
                                <option value="mixtral-8x7b">Mixtral 8x7B</option>
                                <option value="codellama-34b">CodeLlama 34B</option>
                            </optgroup>
                            <optgroup label="Stability AI">
                                <option value="stable-image-ultra">Stable Image Ultra</option>
                                <option value="stable-image-core">Stable Image Core</option>
                                <option value="stable-image-sd3">Stable Image SD3</option>
                                <option value="stable-audio-2">Stable Audio 2</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                
                <div class="top-bar-right">
                    <button class="top-bar-btn" onclick="toggleContextPanel()" title="Context Panel" id="context-toggle-btn">
                        <i class="fas fa-layer-group"></i>
                    </button>
                    <button class="top-bar-btn" onclick="exportConversation()" title="Export to Markdown">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="top-bar-btn" onclick="tagConversation()" title="Organize with Tags">
                        <i class="fas fa-tags"></i>
                    </button>
                    <button class="top-bar-btn" onclick="window.app.openSettingsModal()" title="Settings" id="settings-btn">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="top-bar-btn logout-btn" onclick="logout()" title="Logout" id="logout-btn" style="display:none;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div class="chat-messages-container">
                <!-- Chat Header (for project/conversation context) -->
                <div class="chat-header" id="chat-header" style="display: none;">
                    <div class="chat-breadcrumb">
                        <span class="breadcrumb-item breadcrumb-clickable" id="project-breadcrumb" onclick="window.app.goBackToProject()">
                            <i class="fas fa-folder-open"></i>
                            <span id="project-name"></span>
                        </span>
                        <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
                        <span class="breadcrumb-item active">
                            <i class="fas fa-comment"></i>
                            <span id="conversation-title"></span>
                        </span>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <!-- Empty State -->
                    <div class="empty-state" id="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h2 class="empty-state-title">New Conversation</h2>
                        <p class="empty-state-description">Start a conversation or search your knowledge base.</p>
                    </div>
                </div>
            </div>

            <!-- Context Panel -->
            <div class="context-panel" id="context-panel" style="display: none;">
                <div class="context-header">
                    <h4><i class="fas fa-layer-group"></i> Active Context</h4>
                    <div class="context-actions">
                        <button class="context-btn" onclick="addNewContext()" title="Add Context">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="context-btn" onclick="refreshContextPanel()" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="context-btn" onclick="toggleContextPanel()" title="Close Panel">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="context-content">
                    <div class="context-stats" id="context-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Items:</span>
                            <span class="stat-value" id="total-context-items">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Tokens:</span>
                            <span class="stat-value" id="total-context-tokens">0</span>
                        </div>
                    </div>
                    <div class="context-conversation-section" id="context-conversation-section" style="display: none;">
                        <h5>Context for This Conversation</h5>
                        <div class="conversation-context-list" id="conversation-context-list">
                            <div class="empty-context">No context items added to this conversation yet.</div>
                        </div>
                    </div>
                    <div class="context-items-section">
                        <h5>Available Context Items</h5>
                        <div class="context-search-container">
                            <input type="text" id="context-search" placeholder="Search context items..." onkeyup="searchContextItems()">
                        </div>
                        <div class="context-items-list" id="context-items-list">
                            <div class="loading-context">Loading context items...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Input -->
            <div class="bottom-input-container">
                <div class="kb-search-results" id="kb-search-results" style="display: none;">
                    <!-- Knowledge base search results will appear here -->
                </div>
                
                <div class="input-area">
                    <div class="input-controls-left">
                        <button class="input-control-btn" onclick="triggerFileUpload()" title="Add attachment">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="input-control-btn" onclick="startVoiceInput()" title="Voice Input" id="voice-btn">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    
                    <div class="message-input-container">
                        <textarea id="message-input" placeholder="Ask a question or search knowledge base..." 
                                rows="1" onkeydown="handleInputKeydown(event)" oninput="handleInputChange()"></textarea>
                    </div>
                    
                    <button class="send-button" onclick="sendMessage()" id="send-btn">
                        Send
                    </button>
                </div>
                
                <input type="file" id="file-input" multiple style="display: none;" onchange="window.app.handleContextUpload(event)">
            </div>
        </div>
    </div>

    <!-- Settings Slide-Out Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-panel-overlay" onclick="closeSettingsPanel()"></div>
        <div class="settings-panel-content">
            <!-- Settings Header -->
            <div class="settings-header">
                <div class="settings-title">
                    <i class="fas fa-cog"></i>
                    <h2>Settings</h2>
                </div>
                <button class="settings-close-btn" onclick="closeSettingsPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Settings Navigation -->
            <div class="settings-nav">
                <button class="settings-nav-btn active" data-section="models" onclick="showSettingsSection('models')">
                    <i class="fas fa-robot"></i>
                    Models
                </button>
                <button class="settings-nav-btn" data-section="account" onclick="showSettingsSection('account')">
                    <i class="fas fa-user"></i>
                    Account
                </button>
                <button class="settings-nav-btn" data-section="preferences" onclick="showSettingsSection('preferences')">
                    <i class="fas fa-sliders-h"></i>
                    Preferences
                </button>
            </div>

            <!-- Settings Content -->
            <div class="settings-content">
                <!-- Models Section -->
                <div class="settings-section active" id="models-section">
                    <div class="section-header">
                        <h3>Model Configuration</h3>
                        <p>Manage which models are available in the dropdown and check their access status.</p>
                    </div>

                    <div class="models-container">
                        <div class="models-header">
                            <div class="models-actions">
                                <button class="btn-secondary" onclick="checkAllModelsAccess()">
                                    <i class="fas fa-sync"></i>
                                    Check All Access
                                </button>
                                <button class="btn-primary" onclick="saveModelSettings()">
                                    <i class="fas fa-save"></i>
                                    Save Changes
                                </button>
                            </div>
                        </div>

                        <div class="models-list" id="models-list">
                            <!-- Models will be populated by JavaScript -->
                            <div class="loading-models">Loading model configurations...</div>
                        </div>
                    </div>
                </div>

                <!-- Account Section -->
                <div class="settings-section" id="account-section" style="display: none;">
                    <div class="section-header">
                        <h3>Account Information</h3>
                        <p>View your account details and usage statistics.</p>
                    </div>
                    <div class="account-info">
                        <p>Account settings coming soon...</p>
                    </div>
                </div>

                <!-- Preferences Section -->
                <div class="settings-section" id="preferences-section" style="display: none;">
                    <div class="section-header">
                        <h3>User Preferences</h3>
                        <p>Customize your application experience.</p>
                    </div>
                    <div class="preferences-info">
                        <p>Preference settings coming soon...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Keep existing modals unchanged) -->
    <div id="tag-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-tags"></i> Organize Conversation</h3>
                <span class="close" onclick="closeTagModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="tag-explanation">
                    <p><strong>What are tags?</strong> Tags help you organize and find conversations by topic.</p>
                    <p><strong>Examples:</strong> <code>python</code>, <code>work-project</code>, <code>tutorial</code>, <code>research</code></p>
                    <p><strong>Benefits:</strong> Search conversations by tag, group related discussions, quick filtering</p>
                    <p><strong>How to use:</strong> Type any tag name in the "Search conversations" box to find tagged discussions</p>
                </div>
                
                <div class="tag-input-section">
                    <label for="tag-input"><strong>Add tags to this conversation:</strong></label>
                    <input type="text" id="tag-input" placeholder="Type tags separated by commas (e.g., python, tutorial, debugging)" onkeydown="handleTagInput(event)">
                    <div class="tag-input-help">
                        <small><i class="fas fa-lightbulb"></i> Tip: Use short, descriptive words. Tags are searchable in the conversation list.</small>
                    </div>
                </div>
                
                <div class="current-conversation-tags">
                    <label><strong>Current tags for this conversation:</strong></label>
                    <div class="conversation-current-tags" id="conversation-current-tags">
                        <span class="no-tags">No tags yet</span>
                    </div>
                </div>
                
                <div class="suggested-tags-section">
                    <label><strong>Quick add (click to add):</strong></label>
                    <div class="existing-tags" id="existing-tags">
                        <!-- Existing tags from other conversations will appear here -->
                    </div>
                </div>
                
                <div class="tag-modal-actions">
                    <button class="btn-primary" onclick="saveTags()"><i class="fas fa-save"></i> Save Tags</button>
                    <button class="btn-secondary" onclick="closeTagModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal analytics-modal" style="display: none;">
        <div class="modal-content analytics-dashboard-modal">
            <!-- Analytics Dashboard Header -->
            <div class="analytics-dashboard-header">
                <div class="dashboard-header-left">
                    <div class="dashboard-title-main">
                        <h1>Analytics Dashboard</h1>
                        <span class="live-indicator">
                            <span class="live-dot"></span>
                            Live
                        </span>
                    </div>
                </div>
                <div class="dashboard-header-right">
                    <button class="dashboard-control-btn theme-toggle-btn" onclick="toggleDashboardTheme()" title="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="dashboard-control-btn export-btn" onclick="exportDashboardData()" title="Export Data">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                    <button class="dashboard-control-btn close-btn" onclick="window.app.closeSettingsModal()" title="Close Dashboard">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Dashboard Controls Bar -->
            <div class="dashboard-controls-bar">
                <div class="controls-left">
                    <div class="control-group">
                        <label class="control-label">Time Range:</label>
                        <select class="control-select time-range-selector" id="dashboard-time-range" onchange="updateDashboardTimeRange()">
                            <option value="1">Today</option>
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 3 months</option>
                        </select>
                    </div>
                </div>
                <div class="controls-right">
                    <div class="control-group">
                        <label class="control-label">Auto-refresh:</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="auto-refresh-toggle" class="toggle-input" checked onchange="toggleAutoRefresh()">
                            <label for="auto-refresh-toggle" class="toggle-label"></label>
                        </div>
                        <span class="refresh-interval">30s</span>
                    </div>
                </div>
            </div>

            <div class="modal-body analytics-dashboard-body" id="settings-body">
                <div class="settings-tabs">
                    <button class="control-btn primary active" onclick="showTab('usage')">Usage Stats</button>
                    <button class="control-btn primary" onclick="showTab('whitelist')" id="whitelist-tab">IP Whitelist</button>
                </div>
                
                <div id="usage-tab" class="tab-content analytics-main-content" style="display: block;">
                    <!-- Main Analytics Layout -->
                    <div class="analytics-layout">
                        <!-- Left Main Content -->
                        <div class="analytics-main">
                            <!-- Usage Metrics Chart -->
                            <div class="analytics-widget usage-metrics-widget">
                                <div class="widget-header">
                                    <div class="widget-title">
                                        <i class="fas fa-chart-bar widget-icon"></i>
                                        <div class="widget-title-text">
                                            <h3>Usage Metrics</h3>
                                            <span class="widget-subtitle">Token usage and API calls</span>
                                        </div>
                                    </div>
                                    <div class="widget-controls">
                                        <button class="widget-control-btn" onclick="expandChart('usage-metrics')" title="Expand">
                                            <i class="fas fa-expand"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="widget-content">
                                    <canvas id="llm-usage-chart"></canvas>
                                </div>
                            </div>

                            <!-- Activity Timeline Chart -->
                            <div class="analytics-widget timeline-widget">
                                <div class="widget-header">
                                    <div class="widget-title">
                                        <i class="fas fa-chart-line widget-icon"></i>
                                        <div class="widget-title-text">
                                            <h3>Activity Timeline</h3>
                                            <span class="widget-subtitle">Model usage timeline</span>
                                        </div>
                                    </div>
                                    <div class="widget-controls">
                                        <button class="widget-control-btn" onclick="expandChart('activity-timeline')" title="Expand">
                                            <i class="fas fa-expand"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="widget-content">
                                    <canvas id="activity-timeline-chart"></canvas>
                                </div>
                            </div>

                            <!-- Model Performance Table -->
                            <div class="analytics-widget performance-widget">
                                <div class="widget-header">
                                    <div class="widget-title">
                                        <i class="fas fa-server widget-icon"></i>
                                        <div class="widget-title-text">
                                            <h3>Model Performance</h3>
                                            <span class="widget-subtitle">Detailed performance metrics</span>
                                        </div>
                                    </div>
                                    <div class="widget-controls">
                                        <button class="widget-control-btn" onclick="filterModelPerformance()" title="Filter">
                                            <i class="fas fa-filter"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="widget-content">
                                    <div class="performance-table" id="model-performance-table">
                                        <!-- Table will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>

                            <!-- Activity Log -->
                            <div class="analytics-widget activity-widget">
                                <div class="widget-header">
                                    <div class="widget-title">
                                        <i class="fas fa-list widget-icon"></i>
                                        <div class="widget-title-text">
                                            <h3>Activity Log</h3>
                                            <span class="widget-subtitle">Recent system activities</span>
                                        </div>
                                    </div>
                                    <div class="widget-controls">
                                        <button class="widget-control-btn" onclick="clearActivityLog()" title="Clear Log">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <button class="widget-control-btn" onclick="searchActivityLog()" title="Search">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="widget-content">
                                    <div class="activity-log" id="activity-log">
                                        <!-- Activity log will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Sidebar - Quick Stats -->
                        <div class="analytics-sidebar">
                            <div class="analytics-widget quick-stats-widget">
                                <div class="widget-header">
                                    <div class="widget-title">
                                        <i class="fas fa-tachometer-alt widget-icon"></i>
                                        <div class="widget-title-text">
                                            <h3>Quick Stats</h3>
                                            <span class="widget-subtitle">Performance overview</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="widget-content quick-stats-content">
                                    <div class="quick-stat-item">
                                        <div class="stat-indicator">
                                            <span class="stat-dot active-models"></span>
                                            <span class="stat-label">Active Models</span>
                                        </div>
                                        <div class="stat-value" id="stat-active-models">12</div>
                                    </div>
                                    
                                    <div class="quick-stat-item">
                                        <div class="stat-indicator">
                                            <span class="stat-dot total-requests"></span>
                                            <span class="stat-label">Total Requests</span>
                                        </div>
                                        <div class="stat-value" id="stat-total-requests">1.2M</div>
                                    </div>
                                    
                                    <div class="quick-stat-item">
                                        <div class="stat-indicator">
                                            <span class="stat-dot avg-response"></span>
                                            <span class="stat-label">Avg Response</span>
                                        </div>
                                        <div class="stat-value" id="stat-avg-response">245ms</div>
                                    </div>
                                    
                                    <div class="quick-stat-item">
                                        <div class="stat-indicator">
                                            <span class="stat-dot success-rate"></span>
                                            <span class="stat-label">Success Rate</span>
                                        </div>
                                        <div class="stat-value success" id="stat-success-rate">99.8%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="whitelist-tab" class="tab-content analytics-main-content" style="display:none;">
                    <div class="analytics-layout">
                        <div class="analytics-main" style="width: 100%;">
                            <!-- IP Whitelist Management Widget -->
                            <div class="analytics-widget ip-whitelist-widget">
                                <div class="widget-header">
                                    <div class="widget-title">
                                        <i class="fas fa-shield-alt widget-icon"></i>
                                        <div class="widget-title-text">
                                            <h3>IP Whitelist Management</h3>
                                            <span class="widget-subtitle">Manage authorized IP addresses</span>
                                        </div>
                                    </div>
                                    <div class="widget-controls">
                                        <button class="widget-control-btn" onclick="refreshWhitelist()" title="Refresh">
                                            <i class="fas fa-sync"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="widget-content">
                                    <!-- Current IP Display -->
                                    <div class="current-ip-section">
                                        <div class="current-ip-info">
                                            <span class="current-ip-label">Your Current IP:</span>
                                            <span class="current-ip-value" id="current-ip-display">Loading...</span>
                                            <button class="control-btn primary" onclick="whitelistCurrentIP()" id="whitelist-current-btn">
                                                <i class="fas fa-plus"></i>
                                                Add Current IP
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Add New IP Section -->
                                    <div class="add-ip-section">
                                        <div class="add-ip-form">
                                            <input type="text" class="ip-input" id="new-ip-address" placeholder="192.168.1.1" />
                                            <input type="text" class="ip-input" id="ip-description" placeholder="Description (optional)" />
                                            <button class="control-btn primary" onclick="addIPToWhitelist()">
                                                <i class="fas fa-plus"></i>
                                                Add IP
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- IP Whitelist Table -->
                                    <div class="ip-whitelist-table">
                                        <table class="whitelist-table">
                                            <thead>
                                                <tr>
                                                    <th>IP Address</th>
                                                    <th>Description</th>
                                                    <th>Added Date</th>
                                                    <th>Added By</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="whitelist-table-body">
                                                <tr class="loading-row">
                                                    <td colspan="6" class="loading-cell">
                                                        <i class="fas fa-spinner fa-spin"></i>
                                                        Loading whitelist data...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="static/js/app.js"></script>
    <script>
        // CSRF Token Setup - Add this before all other JavaScript
        window.csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Override fetch to automatically include CSRF tokens
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            // Only add CSRF token for non-GET requests to our own domain
            if (options.method && options.method.toUpperCase() !== 'GET' && 
                (typeof url === 'string' && (url.startsWith('/') || url.startsWith(window.location.origin)))) {
                
                options.headers = options.headers || {};
                
                // Add CSRF token to headers
                if (typeof options.headers === 'object' && !Array.isArray(options.headers)) {
                    options.headers['X-CSRFToken'] = window.csrfToken;
                }
                
                // If sending JSON, also add to body for fallback
                if (options.headers['Content-Type'] === 'application/json' && options.body) {
                    try {
                        const bodyData = JSON.parse(options.body);
                        bodyData.csrf_token = window.csrfToken;
                        options.body = JSON.stringify(bodyData);
                    } catch (e) {
                        // If body isn't valid JSON, just add header
                        console.log('Could not parse JSON body for CSRF token, using header only');
                    }
                }
            }
            
            return originalFetch.call(this, url, options);
        };

        // Global functions for new UI
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const logoText = document.getElementById('logo-text');
            const toggleIcon = document.getElementById('toggle-icon');
            const sidebarMainActions = document.getElementById('sidebar-main-actions');
            const sidebarContent = document.getElementById('sidebar-content');
            const sidebarCollapsedContent = document.getElementById('sidebar-collapsed-content');
            const sidebarFooter = document.getElementById('sidebar-footer');
            const projectsSection = document.getElementById('projects-section');
            
            sidebar.classList.toggle('collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                // Collapsed state - show right arrow (expand icon)
                logoText.style.display = 'none';
                toggleIcon.innerHTML = '<path d="m24,128a8,8,0,0,1,8-8h132.69l-58.35-58.34a8,8,0,0,1,11.32-11.32l72,72a8,8,0,0,1,0,11.32l-72,72a8,8,0,0,1-11.32-11.32l58.35-58.34h-132.69a8,8,0,0,1-8-8zm192-88a8,8,0,0,0,8-8v-176a8,8,0,0,0-16,0v176a8,8,0,0,0,8,8z"></path>';
                sidebarMainActions.style.display = 'none';
                sidebarContent.style.display = 'none';
                sidebarCollapsedContent.style.display = 'block';
                sidebarFooter.querySelector('.settings-label').style.display = 'none';
                // In collapsed state, projects are accessible via collapsed icons
            } else {
                // Expanded state - show left arrow (collapse icon)
                logoText.style.display = 'block';
                toggleIcon.innerHTML = '<path d="M232,128a8,8,0,0,1-8,8H91.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L91.31,120H224A8,8,0,0,1,232,128ZM40,32a8,8,0,0,0-8,8V216a8,8,0,0,0,16,0V40A8,8,0,0,0,40,32Z"></path>';
                sidebarMainActions.style.display = 'block';
                sidebarContent.style.display = 'block';
                sidebarCollapsedContent.style.display = 'none';
                sidebarFooter.querySelector('.settings-label').style.display = 'inline';
                // Hide projects section in expanded content - recent conversations will take full space
                projectsSection.style.display = 'none';
            }
        }

        function toggleSection(sectionName) {
            // Handle new main content views
            if (sectionName === 'recent' && window.app) {
                window.app.showConversationsView();
                return;
            }
            
            if (sectionName === 'projects' && window.app) {
                window.app.showProjectsView();
                return;
            }
            
            // Original sidebar toggle functionality for other sections
            const content = document.getElementById(sectionName + '-content');
            const toggle = document.getElementById(sectionName + '-toggle');
            
            if (content && toggle) {
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    toggle.className = 'fas fa-plus';
                } else {
                    content.classList.add('expanded');
                    toggle.className = 'fas fa-minus';
                }
            }
        }

        function startNewChat() {
            if (window.app && window.app.startNewConversation) {
                window.app.startNewConversation();
            }
        }

        function showNewProjectInput() {
            const inputRow = document.getElementById('new-project-input-row');
            const input = document.getElementById('new-project-input');
            
            inputRow.style.display = 'block';
            input.focus();
        }

        function handleNewProjectInput(event) {
            if (event.key === 'Enter') {
                const input = event.target;
                const projectName = input.value.trim();
                
                if (projectName) {
                    // Handle project creation
                    if (window.app && window.app.createNewProject) {
                        window.app.createNewProject(projectName);
                    }
                    
                    input.value = '';
                    document.getElementById('new-project-input-row').style.display = 'none';
                }
            } else if (event.key === 'Escape') {
                event.target.value = '';
                document.getElementById('new-project-input-row').style.display = 'none';
            }
        }

        function updateModel() {
            if (window.app && window.app.updateModel) {
                window.app.updateModel();
            }
        }

        // Authentication functions (keep existing)
        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/status');
                const data = await response.json();
                
                if (data.auth_enabled) {
                    document.getElementById('logout-btn').style.display = 'block';
                }
                
                // Show free tier usage if applicable
                if (data.free_access && !data.authenticated) {
                    showUsageIndicator(data.free_access);
                }
                
                return data;
            } catch (error) {
                console.error('Failed to check auth status:', error);
                return { authenticated: false, auth_enabled: false };
            }
        }

        function showUsageIndicator(freeAccess) {
            const existingIndicator = document.getElementById('usage-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            const indicator = document.createElement('div');
            indicator.id = 'usage-indicator';
            indicator.className = 'usage-indicator';
            
            const remaining = freeAccess.queries_remaining;
            const total = freeAccess.limit;
            const used = freeAccess.queries_used;
            
            if (remaining <= 0) {
                indicator.className += ' danger';
                const hours = Math.floor(freeAccess.hours_until_reset || 0);
                const minutes = Math.floor(((freeAccess.hours_until_reset || 0) % 1) * 60);
                const resetText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                
                indicator.innerHTML = `
                    <div><strong>Free queries exhausted</strong></div>
                    <div>Used: ${used}/${total}</div>
                    <div><small>Resets in ${resetText}</small></div>
                    <div><small>Login for unlimited access</small></div>
                `;
            } else if (remaining <= 3) {
                indicator.className += ' warning';
                indicator.innerHTML = `
                    <div><strong>${remaining} free queries left</strong></div>
                    <div>Used: ${used}/${total}</div>
                `;
            } else {
                indicator.innerHTML = `
                    <div><strong>${remaining} free queries remaining</strong></div>
                    <div>Used: ${used}/${total}</div>
                `;
            }
            
            document.body.appendChild(indicator);
        }

        async function logout() {
            try {
                const response = await fetch('/auth/logout', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    console.error('Logout failed:', await response.text());
                }
            } catch (error) {
                console.error('Logout failed:', error);
                // Even if logout fails, redirect to login for security
                window.location.href = '/login';
            }
        }

        // Admin functions (keep existing)
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.classList.add('active');
            
            if (tabName === 'whitelist') {
                loadWhitelistData();
            }
        }
        
        async function loadWhitelistData() {
            try {
                // Load current IP
                const ipResponse = await fetch('/admin/current-ip');
                const ipData = await ipResponse.json();
                
                const currentIPDisplay = document.getElementById('current-ip-display');
                const whitelistBtn = document.getElementById('whitelist-current-btn');
                
                if (ipData.is_whitelisted) {
                    currentIPDisplay.innerHTML = `
                        <strong>${ipData.ip_address}</strong> - <span style="color: green;"> Whitelisted</span><br>
                        <small>${ipData.whitelist_info.description || 'No description'}</small>
                    `;
                    whitelistBtn.style.display = 'none';
                } else {
                    currentIPDisplay.innerHTML = `<strong>${ipData.ip_address}</strong> - <span style="color: orange;">Not whitelisted</span>`;
                    whitelistBtn.style.display = 'inline-block';
                }
                
                // Load whitelist
                const whitelistResponse = await fetch('/admin/whitelist');
                const whitelist = await whitelistResponse.json();
                
                const whitelistTable = document.getElementById('whitelist-table');
                if (whitelist.length === 0) {
                    whitelistTable.innerHTML = '<div>No IPs whitelisted</div>';
                } else {
                    whitelistTable.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <th style="text-align: left; padding: 8px;">IP Address</th>
                                    <th style="text-align: left; padding: 8px;">Description</th>
                                    <th style="text-align: left; padding: 8px;">Added</th>
                                    <th style="text-align: center; padding: 8px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${whitelist.map(entry => `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 8px; font-family: monospace;">${entry.ip_address}</td>
                                        <td style="padding: 8px;">${entry.description || 'No description'}</td>
                                        <td style="padding: 8px;">${new Date(entry.created_at).toLocaleDateString()}</td>
                                        <td style="padding: 8px; text-align: center;">
                                            <button class="btn btn-sm btn-danger" onclick="removeIPFromWhitelist('${entry.ip_address}')">Remove</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                
                // Load usage stats
                const statsResponse = await fetch('/admin/usage-stats');
                const stats = await statsResponse.json();
                
                document.getElementById('usage-stats').innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>Today:</strong> ${stats.today_stats.total_queries} queries from ${stats.today_stats.unique_ips} unique IPs<br>
                        <strong>Whitelisted IPs:</strong> ${stats.whitelist_count}
                    </div>
                    <div>
                        <strong>Top IPs (Last 7 Days):</strong>
                        <ul style="margin-top: 10px;">
                            ${stats.top_ips.slice(0, 5).map(ip => `
                                <li style="margin: 5px 0; font-family: monospace;">
                                    ${ip.ip_address}: ${ip.total_queries} queries, ${ip.unique_sessions} sessions
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
                
            } catch (error) {
                console.error('Failed to load whitelist data:', error);
                document.getElementById('whitelist-table').innerHTML = '<div style="color: red;">Failed to load data</div>';
            }
        }
        
        async function whitelistCurrentIP() {
            try {
                const ipResponse = await fetch('/admin/current-ip');
                const ipData = await ipResponse.json();
                
                const description = prompt('Enter description for this IP:', 'Demo Access');
                if (description === null) return;
                
                const response = await fetch('/admin/whitelist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip_address: ipData.ip_address,
                        description: description,
                        created_by: 'admin'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('IP added to whitelist successfully!');
                    loadWhitelistData();
                } else {
                    alert('Error: ' + result.error);
                }
                
            } catch (error) {
                alert('Failed to add IP to whitelist');
            }
        }
        
        async function addIPToWhitelist() {
            const ip = document.getElementById('new-ip-address').value.trim();
            const description = document.getElementById('ip-description').value.trim() || 'Demo Access';
            
            if (!ip) {
                alert('Please enter an IP address');
                return;
            }
            
            try {
                const response = await fetch('/admin/whitelist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip_address: ip,
                        description: description,
                        created_by: 'admin'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('IP added to whitelist successfully!');
                    document.getElementById('new-ip-address').value = '';
                    document.getElementById('ip-description').value = '';
                    loadWhitelistData();
                } else {
                    alert('Error: ' + result.error);
                }
                
            } catch (error) {
                alert('Failed to add IP to whitelist');
            }
        }
        
        async function removeIPFromWhitelist(ip) {
            if (!confirm(`Remove ${ip} from whitelist?`)) return;
            
            try {
                const response = await fetch(`/admin/whitelist/${encodeURIComponent(ip)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('IP removed from whitelist');
                    loadWhitelistData();
                } else {
                    alert('Error: ' + result.error);
                }
                
            } catch (error) {
                alert('Failed to remove IP from whitelist');
            }
        }

        // Settings Panel Functions
        function openSettingsPanel() {
            const panel = document.getElementById('settings-panel');
            panel.classList.add('open');
            // Load models when panel opens
            loadModelConfigurations();
        }

        function closeSettingsPanel() {
            const panel = document.getElementById('settings-panel');
            panel.classList.remove('open');
        }

        function showSettingsSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.settings-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active from all nav buttons
            document.querySelectorAll('.settings-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + '-section').classList.add('active');
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
        }

        // Model management functions
        const availableModels = {
            openai: [
                { value: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', description: 'Fast and efficient model for most tasks' },
                { value: 'gpt-4', name: 'GPT-4', description: 'More capable model for complex reasoning' },
                { value: 'gpt-4-turbo', name: 'GPT-4 Turbo', description: 'Faster GPT-4 with longer context' },
                { value: 'gpt-4o', name: 'GPT-4o', description: 'Latest GPT-4 optimized model' },
                { value: 'gpt-4o-mini', name: 'GPT-4o Mini', description: 'Smaller, faster GPT-4o variant' },
                { value: 'gpt-5', name: 'ChatGPT 5', description: 'Next generation OpenAI model' },
                { value: 'o1-preview', name: 'O1 Preview', description: 'Advanced reasoning model (preview)' },
                { value: 'o1-mini', name: 'O1 Mini', description: 'Compact advanced reasoning model' }
            ],
            anthropic: [
                { value: 'claude-3.5-sonnet', name: 'Claude 3.5 Sonnet', description: 'Latest high-performance Claude model' },
                { value: 'claude-3-opus', name: 'Claude 3 Opus', description: 'Most capable Claude model' },
                { value: 'claude-3-sonnet', name: 'Claude 3 Sonnet', description: 'Balanced performance and speed' },
                { value: 'claude-3-haiku', name: 'Claude 3 Haiku', description: 'Fast and efficient Claude model' }
            ],
            google: [
                { value: 'gemini-pro', name: 'Gemini Pro', description: 'Google\'s flagship language model' },
                { value: 'gemini-flash', name: 'Gemini Flash', description: 'Fast and lightweight Gemini variant' }
            ],
            huggingface: [
                { value: 'llama2-70b', name: 'Llama 2 70B', description: 'Large open-source language model' },
                { value: 'mixtral-8x7b', name: 'Mixtral 8x7B', description: 'Mixture of experts model' },
                { value: 'codellama-34b', name: 'CodeLlama 34B', description: 'Specialized code generation model' }
            ],
            stability: [
                { value: 'stable-image-ultra', name: 'Stable Image Ultra', description: 'Highest quality image generation' },
                { value: 'stable-image-core', name: 'Stable Image Core', description: 'Balanced image generation' },
                { value: 'stable-image-sd3', name: 'Stable Image SD3', description: 'Latest Stable Diffusion model' },
                { value: 'stable-audio-2', name: 'Stable Audio 2', description: 'Audio generation model' }
            ]
        };

        let modelSettings = {};

        async function loadModelConfigurations() {
            const modelsList = document.getElementById('models-list');
            modelsList.innerHTML = '<div class="loading-models">Loading model configurations...</div>';
            
            try {
                // Load current model settings from server
                const response = await fetch('/api/model-settings');
                if (response.ok) {
                    modelSettings = await response.json();
                } else {
                    // Initialize with default settings
                    modelSettings = {};
                    Object.keys(availableModels).forEach(provider => {
                        availableModels[provider].forEach(model => {
                            modelSettings[model.value] = {
                                enabled: model.value !== 'gpt-5', // GPT-5 disabled by default
                                status: 'unknown'
                            };
                        });
                    });
                }
                
                renderModelsList();
                
            } catch (error) {
                console.error('Failed to load model configurations:', error);
                modelsList.innerHTML = '<div class="loading-models" style="color: red;">Failed to load model configurations</div>';
            }
        }

        function renderModelsList() {
            const modelsList = document.getElementById('models-list');
            let html = '';
            
            Object.keys(availableModels).forEach(provider => {
                const providerName = provider.charAt(0).toUpperCase() + provider.slice(1);
                html += `
                    <div class="model-group">
                        <div class="model-group-header">
                            <h4 class="model-group-title">
                                <i class="fas fa-${getProviderIcon(provider)}"></i>
                                ${providerName}
                            </h4>
                            <div class="model-group-actions">
                                <button class="model-group-btn" onclick="toggleGroupModels('${provider}', true)">Enable All</button>
                                <button class="model-group-btn" onclick="toggleGroupModels('${provider}', false)">Disable All</button>
                                <button class="model-group-btn" onclick="checkGroupAccess('${provider}')">Check Access</button>
                            </div>
                        </div>
                        <div class="models-grid">
                `;
                
                availableModels[provider].forEach(model => {
                    const settings = modelSettings[model.value] || { enabled: false, status: 'unknown' };
                    html += `
                        <div class="model-item">
                            <div class="model-info">
                                <input type="checkbox" class="model-checkbox" 
                                       id="model-${model.value}" 
                                       ${settings.enabled ? 'checked' : ''}
                                       onchange="toggleModelEnabled('${model.value}')">
                                <div class="model-details">
                                    <h5 class="model-name">${model.name}</h5>
                                    <p class="model-description">${model.description}</p>
                                </div>
                            </div>
                            <div class="model-status">
                                <div class="model-access-status ${settings.status}">
                                    <span class="status-icon ${settings.status}"></span>
                                    ${getStatusText(settings.status)}
                                </div>
                                <div class="model-actions">
                                    <button class="model-action-btn" onclick="checkModelAccess('${model.value}')" title="Check Access">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            modelsList.innerHTML = html;
        }

        function getProviderIcon(provider) {
            const icons = {
                openai: 'brain',
                anthropic: 'robot',
                google: 'search',
                huggingface: 'heart',
                stability: 'image'
            };
            return icons[provider] || 'cog';
        }

        function getStatusText(status) {
            const statusTexts = {
                active: 'Active',
                limited: 'Limited',
                unavailable: 'No Access',
                checking: 'Checking...',
                unknown: 'Unknown'
            };
            return statusTexts[status] || 'Unknown';
        }

        function toggleModelEnabled(modelValue) {
            if (!modelSettings[modelValue]) {
                modelSettings[modelValue] = { enabled: false, status: 'unknown' };
            }
            modelSettings[modelValue].enabled = document.getElementById(`model-${modelValue}`).checked;
        }

        function toggleGroupModels(provider, enabled) {
            availableModels[provider].forEach(model => {
                const checkbox = document.getElementById(`model-${model.value}`);
                if (checkbox) {
                    checkbox.checked = enabled;
                    toggleModelEnabled(model.value);
                }
            });
        }

        async function checkModelAccess(modelValue) {
            const statusElement = document.querySelector(`#model-${modelValue}`).closest('.model-item').querySelector('.model-access-status');
            const iconElement = statusElement.querySelector('.status-icon');
            
            // Set checking state
            statusElement.className = 'model-access-status checking';
            iconElement.className = 'status-icon checking';
            statusElement.innerHTML = '<span class="status-icon checking"></span>Checking...';
            
            try {
                const response = await fetch('/api/check-model-access', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelValue })
                });
                
                const result = await response.json();
                const status = result.hasAccess ? 'active' : 'unavailable';
                
                modelSettings[modelValue] = modelSettings[modelValue] || {};
                modelSettings[modelValue].status = status;
                
                statusElement.className = `model-access-status ${status}`;
                iconElement.className = `status-icon ${status}`;
                statusElement.innerHTML = `<span class="status-icon ${status}"></span>${getStatusText(status)}`;
                
            } catch (error) {
                console.error('Failed to check model access:', error);
                statusElement.className = 'model-access-status unavailable';
                iconElement.className = 'status-icon unavailable';
                statusElement.innerHTML = '<span class="status-icon unavailable"></span>Error';
            }
        }

        async function checkGroupAccess(provider) {
            const promises = availableModels[provider].map(model => checkModelAccess(model.value));
            await Promise.all(promises);
        }

        async function checkAllModelsAccess() {
            const checkBtn = document.querySelector('.btn-secondary');
            const originalText = checkBtn.innerHTML;
            
            try {
                // Show loading state
                checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
                checkBtn.disabled = true;
                
                const allModels = Object.keys(availableModels).flatMap(provider => 
                    availableModels[provider].map(model => model.value)
                );
                
                const promises = allModels.map(modelValue => checkModelAccess(modelValue));
                await Promise.all(promises);
                
                alert('Model access check completed for all models!');
                
            } catch (error) {
                console.error('Failed to check all models access:', error);
                alert('Failed to check model access: Network error');
            } finally {
                // Restore button state
                checkBtn.innerHTML = originalText;
                checkBtn.disabled = false;
            }
        }

        async function saveModelSettings() {
            const saveBtn = document.querySelector('.btn-primary');
            const originalText = saveBtn.innerHTML;
            
            try {
                // Show loading state
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
                
                const response = await fetch('/api/model-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(modelSettings)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Update the model dropdown based on enabled models
                    updateModelDropdown();
                    alert('Model settings saved successfully!');
                } else {
                    alert(`Failed to save model settings: ${result.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('Failed to save model settings:', error);
                alert('Failed to save model settings: Network error');
            } finally {
                // Restore button state
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        function updateModelDropdown() {
            const dropdown = document.getElementById('llm-model');
            const options = dropdown.querySelectorAll('option');
            
            options.forEach(option => {
                const modelValue = option.value;
                const settings = modelSettings[modelValue];
                
                if (settings) {
                    // Show model only if it's enabled (ignore status - let admin decide via checkboxes)
                    if (settings.enabled) {
                        option.style.display = '';
                    } else {
                        option.style.display = 'none';
                    }
                } else {
                    // If no settings found, show by default (for backward compatibility)
                    option.style.display = '';
                }
            });
        }

        // Check auth status on load and show admin tab if authenticated
        document.addEventListener('DOMContentLoaded', async () => {
            const authStatus = await checkAuthStatus();
            if (authStatus.authenticated) {
                document.getElementById('whitelist-tab').style.display = 'inline-block';
                // Show settings button for authenticated users
                document.getElementById('sidebar-settings-btn').style.display = 'flex';
            }
        });

        // ==================== NEW ANALYTICS DASHBOARD FUNCTIONS ====================

        // Update dashboard based on time range selection
        function updateDashboardTimeRange() {
            const timeRange = document.getElementById('dashboard-time-range').value;
            console.log('Updating dashboard for time range:', timeRange);
            
            // Filter all analytics widgets based on selected time range
            refreshAnalyticsData(timeRange);
        }

        // Refresh analytics data with time filtering
        function refreshAnalyticsData(timeRange) {
            // Here you would typically make API calls to get filtered data
            // For now, we'll just show a loading state and update the displays
            
            const widgets = document.querySelectorAll('.analytics-widget');
            widgets.forEach(widget => {
                const content = widget.querySelector('.widget-content');
                if (content) {
                    content.style.opacity = '0.6';
                    setTimeout(() => {
                        content.style.opacity = '1';
                        console.log(`Refreshed widget data for ${timeRange} days`);
                    }, 500);
                }
            });
        }

        // Clear activity log
        function clearActivityLog() {
            if (confirm('Are you sure you want to clear the activity log? This action cannot be undone.')) {
                const activityLogContainer = document.getElementById('activity-log');
                activityLogContainer.innerHTML = '<div class="empty-log">Activity log cleared</div>';
                console.log('Activity log cleared');
            }
        }

        // IP Whitelist Management Functions
        async function refreshWhitelist() {
            const tableBody = document.getElementById('whitelist-table-body');
            tableBody.innerHTML = `
                <tr class="loading-row">
                    <td colspan="6" class="loading-cell">
                        <i class="fas fa-spinner fa-spin"></i>
                        Refreshing whitelist data...
                    </td>
                </tr>
            `;
            
            // Load the actual data
            await populateWhitelistTable();
        }

        async function populateWhitelistTable() {
            const tableBody = document.getElementById('whitelist-table-body');
            
            try {
                // Fetch real data from API
                const response = await fetch('/api/ip-whitelist');
                if (!response.ok) throw new Error('Failed to fetch whitelist');
                
                const data = await response.json();
                
                if (!data.length) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="loading-cell">
                                No IP addresses in whitelist
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tableBody.innerHTML = data.map(item => {
                    const addedDate = new Date(item.created_at).toLocaleDateString();
                    const status = item.is_active ? 'active' : 'inactive';
                    
                    return `
                        <tr>
                            <td><span class="ip-address">${item.ip_address}</span></td>
                            <td><span class="ip-description">${item.description || 'No description'}</span></td>
                            <td><span class="ip-date">${addedDate}</span></td>
                            <td><span class="ip-date">${item.created_by || 'Unknown'}</span></td>
                            <td><span class="ip-status ${status}">${status.toUpperCase()}</span></td>
                            <td>
                                <div class="ip-actions">
                                    <button class="ip-action-btn" onclick="editIP('${item.id}', '${item.ip_address}', '${item.description || ''}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="ip-action-btn danger" onclick="removeIP('${item.id}', '${item.ip_address}')" title="Remove">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading whitelist:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="loading-cell">
                            <i class="fas fa-exclamation-triangle"></i>
                            Error loading whitelist data
                        </td>
                    </tr>
                `;
            }
        }

        async function addIPToWhitelist() {
            console.log('addIPToWhitelist function called');
            
            const ipInput = document.getElementById('new-ip-address');
            const descInput = document.getElementById('ip-description');
            
            console.log('Input elements:', ipInput, descInput);
            
            if (!ipInput || !descInput) {
                alert('Form elements not found. Please try again.');
                return;
            }
            
            const ip = ipInput.value.trim();
            const description = descInput.value.trim();
            
            console.log('Values:', { ip, description });
            
            if (!ip) {
                alert('Please enter an IP address');
                return;
            }
            
            // Basic IP validation
            const ipRegex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
            if (!ipRegex.test(ip)) {
                alert('Please enter a valid IP address');
                return;
            }
            
            try {
                console.log('Making API call to add IP');
                const response = await fetch('/api/ip-whitelist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ip_address: ip,
                        description: description
                    })
                });
                
                console.log('API response:', response);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add IP');
                }
                
                // Clear inputs
                ipInput.value = '';
                descInput.value = '';
                
                // Refresh the table
                await refreshWhitelist();
                
                alert('IP address added to whitelist successfully');
                
            } catch (error) {
                console.error('Error adding IP:', error);
                alert('Failed to add IP: ' + error.message);
            }
        }

        function whitelistCurrentIP() {
            const currentIPElement = document.getElementById('current-ip-display');
            const currentIP = currentIPElement.textContent;
            
            if (currentIP && currentIP !== 'Loading...') {
                // Set the IP in the form and description
                document.getElementById('new-ip-address').value = currentIP;
                document.getElementById('ip-description').value = 'Current IP Address';
                
                // Add it automatically
                addIPToWhitelist();
            } else {
                alert('Current IP address not available');
            }
        }

        async function editIP(id, ipAddress, currentDescription) {
            const newDescription = prompt('Enter new description for ' + ipAddress + ':', currentDescription);
            if (newDescription !== null && newDescription !== currentDescription) {
                try {
                    const response = await fetch(`/api/ip-whitelist/${id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            description: newDescription
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to update IP');
                    }
                    
                    alert('IP description updated successfully');
                    await refreshWhitelist();
                    
                } catch (error) {
                    console.error('Error updating IP:', error);
                    alert('Failed to update IP: ' + error.message);
                }
            }
        }

        async function removeIP(id, ipAddress) {
            if (confirm('Are you sure you want to remove ' + ipAddress + ' from the whitelist?')) {
                try {
                    const response = await fetch(`/api/ip-whitelist/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to remove IP');
                    }
                    
                    alert('IP address removed from whitelist');
                    await refreshWhitelist();
                    
                } catch (error) {
                    console.error('Error removing IP:', error);
                    alert('Failed to remove IP: ' + error.message);
                }
            }
        }

        // Tab switching function
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.settings-tabs .control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            const tabContent = document.getElementById(tabName + '-tab');
            if (tabContent) {
                tabContent.style.display = 'block';
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'whitelist') {
                loadCurrentIP();
                refreshWhitelist();
            }
        }

        function loadCurrentIP() {
            // For now, show a placeholder IP until backend API is ready
            document.getElementById('current-ip-display').textContent = '192.168.1.100';
            
            // TODO: Uncomment when /api/current-ip endpoint is implemented
            /*
            fetch('/api/current-ip')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('current-ip-display').textContent = data.ip || '192.168.1.100';
                })
                .catch(error => {
                    document.getElementById('current-ip-display').textContent = 'Unable to detect';
                    console.error('Failed to fetch current IP:', error);
                });
            */
        }
    </script>
</body>
</html>